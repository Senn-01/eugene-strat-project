---
rationale: DeepFocus page implementation - Complete focus session tracking with timer functionality, project integration, willpower/mindset tracking, and XP rewards following Duke Nukem difficulty themes
version: 0.2.0
changelog:
  - 0.1.0: Initial comprehensive implementation specification with database schema, component architecture, timer implementation, and XP calculations
  - 0.2.0: Post-implementation critical issues identified - session start failures, analytics violations, color system not rendering, daily commitment UX issues
links:
  - docs/stories/1.5.universal-components-theming.md: Previous story with completed universal component theming
  - docs/brief.md: Core application concept and XP calculation formulas
  - src/components/tactical-map/useTacticalMapState.ts: State management pattern to follow
  - docs/front-end-specs/1-design-tokens-tailwind-v4-theme-configuration.md: DeepFocus green theming system
---

# DeepFocus Implementation - Story 1.6

## Status
ðŸ”„ **PENDING** - Ready for implementation

## Story

**As a** strategic user who has prioritized projects on TacticalMap,
**I want** a dedicated deep work environment with timer functionality and performance tracking,
**so that** I can execute focused sessions on my projects and understand my productivity patterns.

## Scope

Transform the placeholder DeepFocus page into a fully functional deep work session tracker with:
- Project-linked focus sessions (60/90/120 minutes)
- Willpower assessment and difficulty scaling
- Real-time countdown timer with persistence
- Post-session mindset feedback
- XP rewards based on session completion
- Daily session commitment tracking
- Sound notifications

## Acceptance Criteria

### Core Timer Functionality (Simplified Flow)
1. âœ… **Step 1**: User selects project + duration (60/90/120 min) in single view
2. âœ… **Step 2**: Willpower assessment appears after project/duration selection (mandatory)
3. âœ… **Step 3**: Timer starts immediately with real-time countdown + project name + difficulty quote
4. âœ… Timer persists across page navigation using localStorage + timestamp
5. âœ… Interrupt session (10 XP) or complete session (calculated XP)

### Session Management
6. âœ… Post-session mindset feedback: "Shaolin mode!", "Getting there", "What the heck is the zone?"
7. âœ… XP calculation and immediate visual reward
8. âœ… Return to setup for new session

### Daily Commitment (Always Visible)
9. âœ… Slider widget always present on page (non-modal)
10. âœ… Optional interaction - user can set 1-10 sessions target
11. âœ… Auto-saves when changed, resets at midnight
12. âœ… Simple progress indicator when commitment is active

### Technical Requirements
13. âœ… Sessions stored in Supabase with full metadata
14. âœ… Integration with existing XP system using `increment_user_xp` RPC
15. âœ… neo-brutalist design system (Black/White/Dark Green/Bright Green)
16. âœ… Phase-adaptive visual intensity (reduced during active focus sessions)
17. âœ… Sound notification (.wav file) on session completion
18. âœ… Clean, focused interface - no analytics/stats on this page

## Neo-Brutalist Color System (Dev Guide)

### **Core Philosophy: Functional Honesty**

DeepFocus uses a **neo-brutalist system** optimized for cognitive load reduction during focus sessions. Every color serves a specific psychological and functional purpose. No decorative elements.

**Target Users:** Professional developers, PhD students, entrepreneurs - users who value performance over aesthetics.

### **The 4-Color Palette**

```css
/* DeepFocus Color System - DO NOT MODIFY */
:root {
  --brutal-authority: #000000;    /* Black - Structure, borders, definition */
  --brutal-clarity: #ffffff;      /* White - Clean space, maximum contrast */
  --brutal-calm: #224718;         /* Dark Green - Focus states, stability */
  --brutal-energy: #CFE820;       /* Bright Green - Actions, rewards, motivation */
}
```
Color to considerate to spice up the design : 
- Pink (`#E5B6E5`) - Decorative, adds cognitive load, misaligned with target audience
- Cream (`#E5EED0`) - Reduces contrast, prioritizes aesthetics over clarity

### **Phase-Adaptive Color Strategy**

#### **Setup Phase: "Decision Energy"**
**Psychology:** User needs clear choices and confident interaction.
**Visual Approach:** Full neo-brutalist intensity for maximum clarity.

```css
.phase-setup {
  background-color: var(--brutal-clarity);     /* #ffffff - Clean decision space */
  color: var(--brutal-authority);              /* #000000 - Strong text */
  --primary-action: var(--brutal-energy);      /* #CFE820 - Energizing choices */
  --secondary-info: var(--brutal-calm);        /* #224718 - Supporting information */

  /* Full brutal styling */
  border: 4px solid var(--brutal-authority);
  box-shadow: 8px 8px 0px var(--brutal-authority);
}

/* Button states */
.btn-primary-setup {
  background: var(--brutal-energy);            /* #CFE820 */
  color: var(--brutal-authority);              /* #000000 */
  border: 3px solid var(--brutal-authority);
  box-shadow: 6px 6px 0px var(--brutal-authority);
}

.btn-primary-setup:hover {
  transform: translate(2px, 2px);
  box-shadow: 4px 4px 0px var(--brutal-authority);
}

.btn-secondary-setup {
  background: var(--brutal-clarity);           /* #ffffff */
  color: var(--brutal-calm);                   /* #224718 */
  border: 2px solid var(--brutal-authority);
}
```

#### **Willpower Select Phase: "Energy Assessment"**
**Psychology:** User assessing personal capacity, needs confidence in choice.
**Visual Approach:** Maintained intensity with XP preview emphasis.

```css
.phase-willpower {
  background-color: var(--brutal-clarity);     /* #ffffff */
  color: var(--brutal-authority);              /* #000000 */

  /* Slightly reduced shadows for progression feeling */
  border: 3px solid var(--brutal-authority);
  box-shadow: 6px 6px 0px var(--brutal-authority);
}

.willpower-option {
  background: var(--brutal-clarity);           /* #ffffff */
  border: 2px solid var(--brutal-authority);   /* #000000 */
  color: var(--brutal-calm);                   /* #224718 */
}

.willpower-option:hover {
  background: var(--brutal-energy);            /* #CFE820 - Action feedback */
  color: var(--brutal-authority);              /* #000000 - Maximum contrast */
}

/* XP preview - high emphasis */
.xp-preview {
  color: var(--brutal-energy);                 /* #CFE820 - Reward preview */
  font-weight: 900;
}
```

#### **Active Session Phase: "Focus Calm"**
**Psychology:** User in deep work, needs minimal visual distraction.
**Visual Approach:** Reduced brutalist intensity, calm color dominance.

```css
.phase-active {
  background-color: var(--brutal-clarity);     /* #ffffff - Pure clarity */
  color: var(--brutal-calm);                   /* #224718 - Calm authority */

  /* CRITICAL: Reduced visual intensity during focus */
  border: 2px solid rgba(0, 0, 0, 0.6);       /* Softened black */
  box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3); /* Minimal shadows */
}

.timer-display {
  color: var(--brutal-calm);                   /* #224718 - Easy on eyes */
  background: var(--brutal-clarity);           /* #ffffff */
  border: 1px solid rgba(0, 0, 0, 0.4);       /* Very subtle structure */
  /* NO box-shadow - eliminates visual noise */
}

.project-name-active {
  color: var(--brutal-calm);                   /* #224718 - Calming reference */
  opacity: 0.8;                               /* Reduced prominence */
}

.difficulty-quote {
  color: var(--brutal-authority);              /* #000000 - Clear but not dominant */
  opacity: 0.7;
}

/* Interrupt button - deliberately low emphasis */
.btn-interrupt {
  background: var(--brutal-clarity);           /* #ffffff */
  color: #E5B6E5
  border: 2px solid black;
  box-shadow: 2px 2px 0px black;
}
```

#### **Completion Phase: "Victory Celebration"**
**Psychology:** User achieved focus session, deserves maximum dopamine reward.
**Visual Approach:** Maximum brutalist intensity, bright color dominance.

```css
.phase-complete {
  background-color: var(--brutal-clarity);     /* #ffffff - Clean celebration */
  color: var(--brutal-authority);              /* #000000 - Strong definition */

  /* Maximum brutal impact for achievement */
  border: 4px solid var(--brutal-authority);
  box-shadow: 12px 12px 0px var(--brutal-authority); /* Extra bold success */
}

.xp-reward-display {
  background: var(--brutal-calm);              /* #224718 - Grounding base */
  color: var(--brutal-energy);                 /* #CFE820 - Bright reward */
  border: 4px solid var(--brutal-authority);   /* #000000 - Strong frame */
  box-shadow: 8px 8px 0px var(--brutal-authority);
  font-size: 3rem;
  font-weight: 900;
}

.mindset-feedback-buttons {
  background: var(--brutal-clarity);           /* #ffffff */
  border: 2px solid var(--brutal-authority);   /* #000000 */
  color: var(--brutal-calm);                   /* #224718 */
}

.mindset-feedback-buttons:hover {
  background: var(--brutal-energy);            /* #CFE820 - Action feedback */
  color: var(--brutal-authority);              /* #000000 */
}
```

### **Daily Commitment Slider: "Always Visible"**
**Psychology:** Optional motivation tool, should not compete with main flow.
**Visual Approach:** Medium brutalist intensity, functional prominence.

```css
.daily-commitment-slider {
  background: var(--brutal-energy);            /* #CFE820 - Positive association */
  border: 3px solid var(--brutal-authority);   /* #000000 - Clear definition */
  color: var(--brutal-calm);                   /* #224718 - Readable contrast */
  box-shadow: 4px 4px 0px var(--brutal-authority); /* Medium emphasis */
}

.slider-track {
  background: rgba(34, 71, 24, 0.3);          /* Dark green tint */
}

.slider-thumb {
  background: var(--brutal-authority);         /* #000000 - Clear control */
  border: 2px solid var(--brutal-clarity);    /* #ffffff - Definition */
  box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
}

.progress-bar {
  background: var(--brutal-authority);         /* #000000 - Progress indicator */
}

.progress-bar.completed {
  background: var(--brutal-calm);              /* #224718 - Achievement state */
}
```

### **Color Usage Rules (Enforcement)**

#### **REQUIRED Color Combinations:**
```css
/* High contrast text - ALWAYS use these pairs */
.text-on-white {
  background: var(--brutal-clarity);           /* #ffffff */
  color: var(--brutal-authority);              /* #000000 */
}

.text-on-dark-green {
  background: var(--brutal-calm);              /* #224718 */
  color: var(--brutal-clarity);                /* #ffffff */
}

.text-on-bright-green {
  background: var(--brutal-energy);            /* #CFE820 */
  color: var(--brutal-authority);              /* #000000 */
}

.text-on-black {
  background: var(--brutal-authority);         /* #000000 */
  color: var(--brutal-clarity);                /* #ffffff */
}
```

#### **FORBIDDEN Color Combinations:**
```css
/* These combinations fail WCAG contrast requirements */
/* DO NOT USE */
.forbidden-low-contrast {
  /* Dark green on bright green - 2.8:1 ratio */
  background: var(--brutal-energy);            /* #CFE820 */
  color: var(--brutal-calm);                   /* #224718 - FORBIDDEN */
}

.forbidden-invisible {
  /* White on bright green - 1.2:1 ratio */
  background: var(--brutal-energy);            /* #CFE820 */
  color: var(--brutal-clarity);                /* #ffffff - FORBIDDEN */
}
```

### **Shadow and Border Intensity Scale**

```css
/* Use appropriate intensity for context */
.brutal-intensity-maximum {
  border: 4px solid var(--brutal-authority);
  box-shadow: 12px 12px 0px var(--brutal-authority);
  /* Use for: Major achievements, primary CTAs in setup */
}

.brutal-intensity-high {
  border: 3px solid var(--brutal-authority);
  box-shadow: 8px 8px 0px var(--brutal-authority);
  /* Use for: Setup phase, completion rewards */
}

.brutal-intensity-medium {
  border: 2px solid var(--brutal-authority);
  box-shadow: 4px 4px 0px var(--brutal-authority);
  /* Use for: Daily commitment, secondary actions */
}

.brutal-intensity-low {
  border: 2px solid rgba(0, 0, 0, 0.6);
  box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
  /* Use for: Active session elements */
}

.brutal-intensity-minimal {
  border: 1px solid rgba(0, 0, 0, 0.4);
  /* NO box-shadow */
  /* Use for: Timer display during focus */
}
```

### **Implementation Validation Checklist**

Before deploying any DeepFocus component, verify:

- [ ] **Color Count**: Only allowedcolors used 
- [ ] **Contrast Compliance**: All text meets WCAG AA standards (4.5:1 minimum)
- [ ] **Phase Appropriateness**: Visual intensity matches psychological needs
- [ ] **Functional Purpose**: Every color choice serves concentration or decision-making
- [ ] **Neo-Brutalist Authenticity**: No gradients, rounded corners, or decorative elements
- [ ] **Focus Session Optimization**: Active phase has minimal visual noise

### **Why This Color System Works**

1. **Cognitive Load Optimization**: 4 colors = minimal mental categorization
2. **Target Audience Alignment**: Professional, no-nonsense aesthetic
3. **Focus Session Support**: Reduced intensity during concentration periods
4. **Reward Psychology**: Bright green triggers dopamine for achievement
5. **Accessibility Compliance**: High contrast ratios support all users
6. **Neo-Brutalist Authenticity**: Raw, functional, honest design choices

**Remember:** This color system prioritizes user performance over aesthetic preferences. Every choice serves concentration and productivity goals.



## Critical Issues Identified (Post-Implementation)

### ðŸŸ¢ Fixed Issues (Implementation Round 1)
1. âœ… **Session Start Failure**: Fixed missing user_id in session creation - sessions now create successfully
2. âœ… **Daily Commitment Persistence**: Added explicit save button and fixed database persistence with proper user_id
3. âœ… **Analytics Removal**: Removed "Today's Progress" section to comply with "no analytics/stats" requirement
4. âœ… **Basic Color Implementation**: Applied phase-adaptive styling and brutal-* CSS classes

### ðŸŸ¢ Fixed Issues (Implementation Round 2)
5. âœ… **Button Color Issues**: Fixed yellow/grey duration selection buttons to use proper neo-brutalist colors
6. âœ… **XP Gauge Visibility**: Fixed XP gauge text color to white on dark green header background
7. âœ… **Timer Rendering**: Fixed critical layout squishing during active sessions
8. âœ… **Card Backgrounds**: Implemented dark green backgrounds (#224718) with cream text (#E5EED0)
9. âœ… **Timer Color**: Changed timer display to pink (#E5B6E5)
10. âœ… **Interrupt Button**: Changed to lime color (#CFE820)
11. âœ… **XP References**: Removed all XP reward previews from willpower selection

### ðŸ”´ Remaining Issues to Address
- **Color Design Consistency**: Some elements may still inherit tactical map colors or need further refinement
- **Visual Polish**: Additional neo-brutalist styling refinements needed across components
- **Component Integration**: Ensure all deep-focus components consistently follow the 6-color palette
- **Edge Cases**: Additional testing needed for timer persistence and session state management

### ðŸŸ¡ Design Areas for Further Review
- **Phase Transitions**: Ensure smooth visual transitions between setup/willpower/active/complete phases
- **Responsive Behavior**: Verify layout integrity across different screen sizes
- **Accessibility**: Color contrast validation for all new color combinations

## Implementation Tasks (Status Update)

### Phase 1: Critical Bug Fixes âœ… COMPLETE
- [x] **Task 1.1**: Fix session creation error - debug "Failed to start session" issue
- [x] **Task 1.2**: Add explicit save button to daily commitment slider
- [x] **Task 1.3**: Remove all analytics from page (Today's Progress section)
- [x] **Task 1.4**: Implement proper neo-brutalist color classes throughout components

### Phase 2: Design System Implementation âœ… COMPLETE
- [x] **Task 2.1**: Apply phase-adaptive styling (setup vs active vs complete)
- [x] **Task 2.2**: Replace all generic Tailwind with brutal-* design tokens
- [x] **Task 2.3**: Implement proper visual intensity scaling per phase
- [x] **Task 2.4**: Test color accessibility compliance

### Phase 3: Database Setup âœ… COMPLETE
- [x] **Task 3.1**: Create sessions table migration with RLS policies
- [x] **Task 3.2**: Create daily_commitments table migration with RLS policies
- [x] **Task 3.3**: Implement Supabase RPC function (`complete_session`)
- [x] **Task 3.4**: Test database schema with sample data

### Phase 4: Color System Refinement âœ… COMPLETE
- [x] **Task 4.1**: Fix duration button colors (remove yellow/grey)
- [x] **Task 4.2**: Implement dark green card backgrounds with cream text
- [x] **Task 4.3**: Apply pink color to timer display
- [x] **Task 4.4**: Apply lime color to interrupt button
- [x] **Task 4.5**: Remove XP references from willpower selection

### Phase 5: Remaining Polish ðŸ”„ IN PROGRESS
- [ ] **Task 5.1**: Comprehensive color audit across all components
- [ ] **Task 5.2**: Test session completion flow end-to-end
- [ ] **Task 5.3**: Validate timer persistence across page navigation
- [ ] **Task 5.4**: Final accessibility and responsive design validation


### XP Integration
Use existing `increment_user_xp` RPC and XP event system:

```typescript
// Award XP and trigger animation
await supabase.rpc('increment_user_xp', { xp_amount: calculatedXP });

// Trigger XP gauge animation
const event = new CustomEvent('xp-update', { detail: calculatedXP });
window.dispatchEvent(event);
```



## Testing Requirements

### Integration Tests
- [ ] Session creation and completion flow
- [ ] XP calculation accuracy
- [ ] Timer persistence across navigation
- [ ] Daily commitment tracking

### Component Tests
- [ ] SessionSetup form validation
- [ ] Timer countdown accuracy
- [ ] SessionComplete mindset selection
- [ ] DailyCommitment progress display

### Database Tests
- [ ] RLS policy enforcement
- [ ] RPC function correctness
- [ ] Data integrity constraints

## Success Criteria

1. âœ… User can start timed focus sessions linked to active projects
2. âœ… Timer persists across page navigation and browser refresh
3. âœ… XP is correctly calculated and awarded based on willpower/duration
4. âœ… Daily commitment tracking works accurately
5. âœ… Sound notification plays on session completion
6. âœ… All sessions are stored in database with full metadata
7. âœ… UI follows neo-brutalist green theming for DeepFocus
8. âœ… Performance is smooth with no timer drift or lag

---
