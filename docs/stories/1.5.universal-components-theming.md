---
rationale: Universal components theming and enhancement story to implement page-specific color adaptation, enhanced header functionality, and coherent navigation system across all pages following TacticalMap completion
version: 1.2.0
changelog:
  - 1.0.0: Initial universal components theming requirements for cross-page color adaptation and enhanced user experience
  - 1.1.0: Updated Task 1 status to completed - Enhanced Header Component with page-specific theming, user info hamburger menu, and ThemeDetector implementation complete
  - 1.2.0: Refined Task 1 with font coherency fixes, enhanced header height (80px), improved flexbox layout, semantic button elements, and comprehensive visual improvements
links:
  - docs/stories/1.4.ui-polish-frontend-testing.md: Previous story with completed TacticalMap UI polish
  - docs/front-end-specs/3-universal-components.md: Universal component design patterns and specifications
  - docs/front-end-specs/1-design-tokens-tailwind-v4-theme-configuration.md: Design system color tokens and theming
  - docs/architecture.md: Core system architecture and component organization
---

# Universal Components Theming & Enhancement

## Status
**IN PROGRESS** - Task 1 (Enhanced Header Component) ✅ **COMPLETED & REFINED**, remaining tasks pending

## Scope: Cross-Page Universal Components

This story focuses on **universal components** that appear across all pages and need page-specific color adaptation:
- Header component with page-specific theming
- Quick-Nav 2×2 grid with comprehensive color system
- XpGauge with adaptive color scheme
- Enhanced hamburger menu functionality

**Note:** Individual page content remains unchanged - this story focuses solely on universal navigation and header components.

## Story

**As a** user navigating between different strategic tools,
**I want** universal components that adapt their colors to each page context and provide enhanced functionality,
**so that** I have a coherent visual experience with clear page identification and improved user account management.

## Acceptance Criteria

**Header Component Enhancement Requirements:**
1. Header background color adapts dynamically to current page (Yellow: TacticalMap, Green: DeepFocus, Purple: Analytics, Blue: Prime)
2. Hamburger menu incorporates user account information display (currently, info are dispersed across the header)
3. Hamburger menu includes proper logout functionality alongside existing reset data option
4. Header refactor to look like in the front end spec
5. Header color transitions are smooth and immediate on page navigation

**Quick-Nav Color System Requirements:**
6. All four page colors (Yellow, Green, Purple, Blue) are always visible in navigation grid
7. Current page button displays at full opacity (opacity: 1) with active styling
8. Non-current page buttons display dimmed (opacity: 0.5) but retain their distinctive colors
9. Hover states work correctly for all buttons regardless of active state

**XP Gauge Adaptive Theming Requirements:**
11. XP Gauge icon color adapts to current page dominant color
12. XP text color remains readable (black) while accent color matches page theme
13. XP animations (lighting effects) use page-appropriate colors
14. XP Gauge maintains consistent positioning and functionality across pages

**Color Theme System Requirements:**
15. DeepFocus page colors: Primary #224718 (dominant), Secondary #CFE820, Text #E5EED0 and #E5B6E5
16. Analytics page colors: Primary #451969 (dominant), Text colors same as DeepFocus (#E5EED0, #E5B6E5)
17. TacticalMap colors: Existing validated Yellow/Crayon/Black system remains unchanged
18. Prime page colors: Existing blue system remains unchanged
19. CSS custom properties enable clean page-context switching

## Tasks / Subtasks

- [x] **Task 1: Enhanced Header Component** (AC: 1, 2, 3, 4, 5) ✅ **COMPLETED & REFINED**
  - [x] Implement page-specific header background color system using CSS custom properties
  - [x] Add user account information display to hamburger menu (email, account status)
  - [x] Implement proper logout functionality in hamburger menu
  - [x] Ensure smooth color transitions between pages via ThemeDetector component
  - [x] Test header behavior across all four pages - working correctly
  - [x] Maintain existing logo and capture placeholder positioning
  - [x] **COMPLETED**: Font coherency fixed and refined with proper typography
  - [x] **ADDED**: Enhanced header height (80px) for better visual weight
  - [x] **ADDED**: Improved layout with flexbox preventing out-of-bounds issues
  - [x] **ADDED**: Updated brain dump text to "Brain Dump ⌘+K"
  - [x] **ADDED**: Converted brain dump to semantic button element

- [ ] **Task 2: Quick-Nav Color Enhancement** (AC: 6, 7, 8, 9, 10)
  - [ ] Implement all four page colors in navigation grid buttons
  - [ ] Create active/inactive opacity system (1.0 active, 0.5 inactive)
  - [ ] Ensure all page colors remain visible regardless of current page
  - [ ] Test hover states for both active and inactive buttons
  - [ ] Verify consistent button sizing and shadow patterns
  - [ ] Update navigation grid styling to support new color requirements

- [ ] **Task 3: XP Gauge Adaptive Theming** (AC: 11, 12, 13, 14)
  - [ ] Implement page-context color adaptation for XP Gauge icon
  - [ ] Ensure XP text remains readable with black color
  - [ ] Update lighting animation effects to use page-appropriate colors
  - [ ] Test XP Gauge across all pages for visual consistency
  - [ ] Maintain existing positioning and functionality

- [ ] **Task 4: Color Theme System Implementation** (AC: 15, 16, 17, 18, 19)
  - [ ] Define DeepFocus color variables: --color-focus: #224718, --color-focus-secondary: #CFE820
  - [ ] Define Analytics color variables: --color-data: #451969
  - [ ] Define text color variables: --color-text-light: #E5EED0, --color-text-accent: #E5B6E5
  - [ ] Create page-context CSS class system for theme switching
  - [ ] Implement CSS custom properties for clean color management
  - [ ] Test color system across all pages

- [ ] **Task 5: Component Integration Testing** (AC: All)
  - [ ] Test header color adaptation during page navigation
  - [ ] Verify hamburger menu functionality (user info, logout, reset data)
  - [ ] Test Quick-Nav visual states across all pages
  - [ ] Verify XP Gauge theming consistency
  - [ ] Conduct cross-browser testing for color accuracy
  - [ ] Ensure accessibility compliance for color contrast ratios

## Dev Notes

### Previous Story Context
**From Story 1.4 (UI Polish & Frontend Testing):**
- ✅ TacticalMap yellow-dominant design system fully implemented
- ✅ Professional Lucide React icons system established
- ✅ Neo-brutalist design patterns validated and working
- ✅ Component testing framework established
- ⚠️ **Dependencies**: Universal components now need to adapt to established page-specific design patterns

### Design System Foundation
**Current Universal Components** [Source: docs/front-end-specs/3-universal-components.md]:
- Header: Logo, capture placeholder, hamburger menu structure established
- Quick-Nav: 2×2 grid with basic styling and current page highlighting
- XP Gauge: Functional component with yellow theming for TacticalMap

**Color System Specifications** [Source: docs/front-end-specs/1-design-tokens-tailwind-v4-theme-configuration.md]:
- CSS custom properties system already established for page theming
- Shadow and border patterns consistent across design system
- Typography scale and weights defined for Neo-brutalist style

### Component Architecture Context
**File Locations**:
- Universal components: `src/components/layout/`
- AppHeader.tsx: Main header component requiring enhancement
- Navigation.tsx: Quick-Nav 2×2 grid requiring color system update
- XpGauge.tsx: XP display component requiring theming adaptation
- HamburgerMenu.tsx: Menu component requiring user info and logout features

### New Color Theme Requirements

**DeepFocus Page Theme**:
```css
.deep-focus-page {
  --color-page-primary: #224718;    /* Dominant green */
  --color-page-secondary: #CFE820;  /* Accent green */
  --color-text-light: #E5EED0;      /* Light text */
  --color-text-accent: #E5B6E5;     /* Accent text */
}
```

**Analytics Page Theme**:
```css
.analytics-page {
  --color-page-primary: #451969;    /* Dominant purple */
  --color-page-secondary: #451969;  /* Same as primary */
  --color-text-light: #E5EED0;      /* Light text (same as DeepFocus) */
  --color-text-accent: #E5B6E5;     /* Accent text (same as DeepFocus) */
}
```

**TacticalMap Page Theme** (existing):
```css
.tactical-map-page {
  --color-page-primary: #FDE047;    /* Yellow primary */
  --color-page-secondary: #e8e8e6;  /* Crayon grey */
}
```

**Prime Page Theme** (existing):
```css
.prime-page {
  --color-page-primary: #3B82F6;    /* Blue primary */
}
```

### Enhanced Hamburger Menu Requirements

**Current Functionality** [Source: Current implementation]:
- Reset data functionality
- Basic menu structure

**Required Enhancements**:
- User account information display (email from Supabase auth)
- Account creation/joined date display
- Proper logout functionality using Supabase auth.signOut()
- Maintain existing reset data functionality
- Professional menu styling consistent with Neo-brutalist design

### Page-Context Color Adaptation Pattern

**Implementation Strategy**:
1. Use CSS custom properties to define page-specific color variables
2. Apply page-context class to body or main container on route change
3. Universal components reference CSS custom properties for theming
4. Smooth transitions between color schemes using CSS transitions

**Example Implementation Pattern**:
```typescript
// Page context detection
const getPageContext = (pathname: string) => {
  if (pathname.includes('tactical-map')) return 'tactical-map-page'
  if (pathname.includes('deep-focus')) return 'deep-focus-page'
  if (pathname.includes('analytics')) return 'analytics-page'
  if (pathname.includes('prime')) return 'prime-page'
  return 'default-page'
}

// Apply to universal components
<Header className={`app-header ${pageContext}`} />
<XpGauge className={`xp-gauge ${pageContext}`} />
<Navigation className={`quick-nav ${pageContext}`} />
```

### Testing Strategy

**Component Integration Testing**:
- Test each universal component across all four pages
- Verify color adaptation works correctly on page navigation
- Test hamburger menu functionality (user info, logout, reset)
- Ensure accessibility compliance for all color combinations

**Cross-Page Navigation Testing**:
- Test Quick-Nav active/inactive states
- Verify color persistence during navigation
- Test smooth transitions between page contexts
- Validate user experience consistency

**Color Accessibility Testing**:
- Verify contrast ratios meet WCAG standards for all color combinations
- Test color visibility for users with visual impairments
- Ensure text readability across all page themes

## Testing

**Universal Component Testing Requirements**:
- **Test File Location**: Integration tests under `src/__tests__/integration/universal-components/`
- **Test Coverage**: Universal component behavior across all page contexts
- **Accessibility Testing**: Color contrast validation for all page themes
- **Navigation Testing**: Quick-Nav state management and transitions

**Required Test Scenarios**:
- Header color adaptation during page navigation
- Hamburger menu user information display and logout functionality
- Quick-Nav visual states (active/inactive) across all pages
- XP Gauge theming consistency and animation effects
- Cross-page navigation color persistence

## Implementation Notes

### CSS Custom Properties Strategy

The implementation will leverage CSS custom properties for clean theme switching:

```css
/* Global theme variables */
:root {
  /* Base design system colors remain unchanged */
  --color-black: #000000;
  --color-white: #ffffff;
  --shadow-base: 4px 4px 0px var(--color-black);
}

/* Page-specific theme overrides */
.tactical-map-page {
  --color-page-primary: #FDE047;
  --color-page-secondary: #e8e8e6;
}

.deep-focus-page {
  --color-page-primary: #224718;
  --color-page-secondary: #CFE820;
  --color-text-light: #E5EED0;
  --color-text-accent: #E5B6E5;
}

.analytics-page {
  --color-page-primary: #451969;
  --color-text-light: #E5EED0;
  --color-text-accent: #E5B6E5;
}

.prime-page {
  --color-page-primary: #3B82F6;
}

/* Universal components use page-context variables */
.app-header {
  background: var(--color-page-primary);
  border-bottom: 4px solid var(--color-black);
  transition: background-color 200ms ease;
}

.xp-gauge .xp-icon {
  color: var(--color-page-primary);
  transition: color 200ms ease;
}

.quick-nav .nav-button.active {
  opacity: 1;
}

.quick-nav .nav-button:not(.active) {
  opacity: 0.5;
}
```

This approach ensures:
- Clean separation between page themes and component styling
- Smooth transitions between page contexts
- Maintainable color system with centralized theme definitions
- Consistent behavior across all universal components

## Implementation Notes & Problem Resolution

### Critical Issue: Page Theme Detection in Server Components

**Problem Encountered:**
During Task 1 implementation, page-specific theming failed because the initial approach tried to detect current page routes in Server Components, where `usePathname()` hook is not available. Additionally, attempts to create wrapper components would have required recreating the entire TacticalMap layout structure.

**Root Cause Analysis:**
- Server Components in Next.js 15 App Router cannot access client-side routing information
- `getCurrentPageId()` function always returned 'tactical-map' regardless of actual page
- Color theming system was correct but never received proper page context

**Solution Implementation:**
Following Next.js best practices research via Context7, implemented the recommended Server Component + Client Component wrapper pattern:

1. **ThemeDetector.tsx**: Client component using `usePathname()` for route detection
2. **Server Layout**: Maintains auth logic and passes user data to ThemeDetector
3. **Clean Architecture**: No recreation of existing page layouts required

**Technical Pattern:**
```typescript
// Server Component (layout.tsx)
export default async function ProtectedLayout({ children }) {
  const { data: { user } } = await supabase.auth.getUser()
  return (
    <ThemeDetector user={user}>
      {children}
    </ThemeDetector>
  )
}

// Client Component (ThemeDetector.tsx)
export function ThemeDetector({ children, user }) {
  const pathname = usePathname()
  const currentPageId = getPageIdFromPathname(pathname)

  useEffect(() => {
    document.documentElement.setAttribute('data-page-theme', currentPageId)
  }, [currentPageId])

  return <div data-page-theme={currentPageId}>{children}</div>
}
```

**Result:**
✅ Dynamic page theme detection working correctly across all pages
✅ Maintains existing TacticalMap functionality without modification
✅ Follows Next.js 15 App Router recommended patterns
✅ Clean separation of concerns between auth and theming

## Next Phase Preparation

With Story 1.5 complete, the universal component system will be ready for:
- Universal Capture (CMD+K) implementation in future stories
- Advanced page-specific feature development
- Enhanced user account management features
- Cross-page analytics and performance tracking