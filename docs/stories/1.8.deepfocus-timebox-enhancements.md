---
rationale: DeepFocus enhancement to full time-boxing system with session goals, goal completion tracking, today's activity feed, daily capacity meter, and daily intention ritual - transforming simple session tracking into comprehensive performance intelligence
version: 1.0.0
changelog:
  - 1.0.0: Initial comprehensive specification with database migrations, component architecture, and implementation phases
links:
  - docs/brief.md: Updated vision with Strava-inspired time-boxing philosophy
  - docs/stories/1.6.deepfocus-implementation.md: Current DeepFocus implementation baseline
  - docs/architecture.md: Technical patterns and component structure
---

# DeepFocus Time-Boxing Enhancements - Story 1.8

## Status
ğŸ“‹ **PLANNING** - Implementation plan ready

## Story

**As a** strategic user tracking focused work sessions,
**I want** comprehensive time-boxing features with goal setting, daily intentions, and activity tracking,
**so that** I can pre-commit to specific objectives, monitor daily capacity, and analyze what I actually accomplish.

## Vision Alignment

This story transforms DeepFocus from simple session tracking into the **Strava for work** foundation:
- **Pre-commitment**: Set session goals before starting (time-boxing core principle)
- **Goal tracking**: Did you achieve what you planned? (accountability loop)
- **Daily intention**: Commit to hours at start of day (builds habit)
- **Activity feed**: See today's sessions like Strava activity cards (immediate feedback)
- **Capacity awareness**: Track progress toward daily target (sustainable performance)

## Scope

### What We're Adding
1. **Session goal input** (optional) - "What will you accomplish?"
2. **Goal completion tracking** - Yes/Partially/No post-session
3. **Session notes** (optional) - Quick reflection after completion
4. **Daily intention ritual** - First visit modal for daily target setting
5. **Today's activity feed** - Strava-style session cards showing completed work
6. **Daily capacity meter** - Visual progress toward daily hour commitment

### What Stays the Same
- Timer functionality and persistence
- Willpower assessment system
- XP calculations
- Duke Nukem difficulty quotes
- Neo-brutalist DeepFocus color scheme (dark green #224718, lime #CFE820, cream #E5EED0)

## Database Changes

### 1. Extend `sessions` Table

```sql
-- Migration: Add time-boxing fields to sessions table
ALTER TABLE sessions
  ADD COLUMN session_goal TEXT,
  ADD COLUMN goal_completed BOOLEAN,
  ADD COLUMN session_notes TEXT;

-- Comments for clarity
COMMENT ON COLUMN sessions.session_goal IS 'User''s planned objective for this session (optional)';
COMMENT ON COLUMN sessions.goal_completed IS 'True=completed, False=not completed, NULL=partially or not tracked';
COMMENT ON COLUMN sessions.session_notes IS 'Post-session reflection notes (optional)';
```

**Migration Safety:**
- All new columns nullable (won't break existing data)
- Existing sessions have NULL values for new fields
- No data loss, backward compatible

### 2. Create `daily_intentions` Table

```sql
-- Migration: Create daily intentions table
CREATE TABLE daily_intentions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  target_hours INTEGER NOT NULL CHECK (target_hours >= 1 AND target_hours <= 8),
  priority_project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- Ensure one intention per user per day
  UNIQUE(user_id, date)
);

-- Index for fast daily lookups
CREATE INDEX idx_daily_intentions_user_date ON daily_intentions(user_id, date);

-- Row Level Security
ALTER TABLE daily_intentions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own daily intentions"
  ON daily_intentions
  FOR ALL
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);
```

### 3. New RPC Function: `get_daily_stats`

```sql
-- Replace existing get_today_sessions RPC with enhanced version
CREATE OR REPLACE FUNCTION get_daily_stats(user_id_param UUID)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  result JSON;
  today_date DATE := CURRENT_DATE;
BEGIN
  SELECT json_build_object(
    'sessions_completed', COUNT(s.id) FILTER (WHERE s.is_completed = true),
    'total_hours', COALESCE(SUM(s.duration) FILTER (WHERE s.is_completed = true) / 60.0, 0),
    'daily_intention', (
      SELECT json_build_object(
        'target_hours', di.target_hours,
        'priority_project_id', di.priority_project_id,
        'priority_project_name', p.name
      )
      FROM daily_intentions di
      LEFT JOIN projects p ON p.id = di.priority_project_id
      WHERE di.user_id = user_id_param AND di.date = today_date
      LIMIT 1
    ),
    'today_sessions', (
      SELECT json_agg(
        json_build_object(
          'id', s.id,
          'project_id', s.project_id,
          'project_name', proj.name,
          'duration', s.duration,
          'started_at', s.started_at,
          'willpower', s.willpower,
          'mindset', s.mindset,
          'session_goal', s.session_goal,
          'goal_completed', s.goal_completed,
          'xp_earned', s.xp_earned
        )
        ORDER BY s.started_at DESC
      )
      FROM sessions s
      JOIN projects proj ON proj.id = s.project_id
      WHERE s.user_id = user_id_param
        AND DATE(s.started_at) = today_date
        AND s.is_completed = true
    )
  ) INTO result
  FROM sessions s
  WHERE s.user_id = user_id_param AND DATE(s.started_at) = today_date;

  RETURN result;
END;
$$;
```

## Frontend Architecture

### Component Structure

```
src/components/deep-focus/
â”œâ”€â”€ SessionSetup.tsx              # ENHANCE: Add goal input field
â”œâ”€â”€ SessionComplete.tsx           # ENHANCE: Add goal completion + notes
â”œâ”€â”€ ActiveSession.tsx             # KEEP: Show goal during session
â”œâ”€â”€ DailyCommitmentSlider.tsx     # KEEP: Existing functionality
â”œâ”€â”€ DailyIntentionModal.tsx       # NEW: First-visit daily target modal
â”œâ”€â”€ TodaysActivityFeed.tsx        # NEW: Session cards feed
â”œâ”€â”€ SessionCard.tsx               # NEW: Individual session display
â”œâ”€â”€ DailyCapacityMeter.tsx        # NEW: Progress bar toward target
â”œâ”€â”€ useDeepFocusState.ts          # ENHANCE: Add new state management
â”œâ”€â”€ useSessionTimer.ts            # KEEP: Existing timer logic
â”œâ”€â”€ types.ts                      # ENHANCE: Add new types
â””â”€â”€ constants.ts                  # KEEP: XP and quotes
```

### New TypeScript Types

```typescript
// Add to types.ts
export interface SessionGoal {
  goal: string;
  completed: boolean | null; // true/false/null
  notes?: string;
}

export interface DailyIntention {
  target_hours: number;
  priority_project_id?: string;
  priority_project_name?: string;
}

export interface CompletedSession {
  id: string;
  project_id: string;
  project_name: string;
  duration: SessionDuration;
  started_at: string;
  willpower: WillpowerLevel;
  mindset: MindsetLevel;
  session_goal?: string;
  goal_completed?: boolean | null;
  xp_earned: number;
}

export interface DailyStats {
  sessions_completed: number;
  total_hours: number;
  daily_intention: DailyIntention | null;
  today_sessions: CompletedSession[];
}

// Extend DeepFocusState
export interface DeepFocusState {
  phase: SessionPhase;
  availableProjects: Project[];
  sessionConfig: SessionConfig | null;
  activeSession: ActiveSession | null;
  sessionGoal: string;  // NEW
  dailyStats: DailyStats | null;  // NEW (replaces dailyCommitment)
  showDailyIntentionModal: boolean;  // NEW
  isLoading: boolean;
  error: string | null;
}
```

### New Components Specifications

#### 1. DailyIntentionModal.tsx

**Purpose**: First-visit modal for setting daily focus target

**Design (Neo-Brutalist)**:
```tsx
// Modal overlay: Semi-transparent black
// Modal container: White bg, 4px black border, 8px shadow
// Header: Dark green #224718 bg, cream text
// Slider: Lime #CFE820 track, black thumb
// Project dropdown: White bg, 2px black border
// CTA button: Lime bg, black text, 3px border
```

**UX Flow**:
1. Check if intention exists for today on page mount
2. If no intention and first visit: show modal
3. Slider: 1-8 hours (default 4)
4. Optional: Select priority project from active projects
5. "Set Daily Target" button saves and closes
6. "Skip Today" button closes without saving

**State Integration**:
```typescript
const handleSetIntention = async (hours: number, projectId?: string) => {
  await supabase.from('daily_intentions').upsert({
    user_id: user.id,
    date: new Date().toISOString().split('T')[0],
    target_hours: hours,
    priority_project_id: projectId || null
  });
  // Update local state
  // Close modal
};
```

#### 2. TodaysActivityFeed.tsx

**Purpose**: Display completed sessions for today as Strava-style cards

**Design (Neo-Brutalist)**:
```tsx
// Container: Cream bg #E5EED0, 2px black border
// Header: "Today's Sessions" uppercase, bold
// Empty state: "No sessions completed yet today"
// Cards: Stack vertically, 8px gap
```

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TODAY'S SESSIONS                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 09:15 AM â€¢ 90 min               â”‚ â”‚
â”‚ â”‚ Project: Build Landing Page      â”‚ â”‚
â”‚ â”‚ Goal: Complete hero section âœ“   â”‚ â”‚
â”‚ â”‚ Mindset: Shaolin Mode           â”‚ â”‚
â”‚ â”‚ +110 XP                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 11:30 AM â€¢ 60 min               â”‚ â”‚
â”‚ â”‚ Project: Fix Auth Bug           â”‚ â”‚
â”‚ â”‚ Goal: Investigate error logs âš ï¸ â”‚ â”‚
â”‚ â”‚ Mindset: Getting There          â”‚ â”‚
â”‚ â”‚ +40 XP                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. SessionCard.tsx

**Purpose**: Individual session display component

**Props**:
```typescript
interface SessionCardProps {
  session: CompletedSession;
  onClick?: () => void; // For future expansion (session details modal)
}
```

**Design Elements**:
- Time stamp: Bold, dark green
- Project name: 16px, black
- Goal with status icon: âœ“ (green), âš ï¸ (yellow), âœ— (red), - (not set)
- Mindset badge: Color-coded (Shaolin=green, Getting There=yellow, What Zone=red)
- XP earned: Lime color, bold
- Border: 2px black, 2px shadow

#### 4. DailyCapacityMeter.tsx

**Purpose**: Visual progress toward daily hour target

**Design (Neo-Brutalist)**:
```tsx
// Container: White bg, 2px black border, 4px shadow
// Header: "Daily Capacity"
// Progress bar:
//   - Track: Light grey bg
//   - Fill: Dark green #224718
//   - Border: 2px black
// Text: "4.5 / 4 hours" (can exceed target)
// Over-target indicator: Fill becomes lime #CFE820 when exceeded
```

**States**:
- No intention set: Show "Set daily target to track progress"
- Under target: Dark green fill
- Met target: Dark green fill, show âœ“
- Over target: Lime fill, show ğŸ”¥

### Page Layout Restructure

**New page structure**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (Universal)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LEFT COLUMN (60%) â”‚ RIGHT SIDEBAR (40%)        â”‚
â”‚                   â”‚                             â”‚
â”‚ [Session Setup    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  or Timer         â”‚ â”‚ Daily Capacity Meter    â”‚â”‚
â”‚  or Complete]     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                   â”‚                             â”‚
â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                   â”‚ â”‚ Today's Activity Feed   â”‚â”‚
â”‚                   â”‚ â”‚ (Session Cards)         â”‚â”‚
â”‚                   â”‚ â”‚                         â”‚â”‚
â”‚                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                   â”‚                             â”‚
â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                   â”‚ â”‚ Daily Commitment Slider â”‚â”‚
â”‚                   â”‚ â”‚ (Moved to bottom)       â”‚â”‚
â”‚                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Plan

### Phase 1: Database Migration (1-2 hours)
**Tasks:**
1. Create migration file: `20250104_enhance_sessions_timebox.sql`
2. Test migration on local Supabase
3. Add new columns to sessions table
4. Create daily_intentions table with RLS
5. Update/replace get_today_sessions RPC with get_daily_stats
6. Test RPC function with sample data
7. Apply to production Supabase

**Acceptance:**
- âœ… Migration runs without errors
- âœ… Existing sessions data intact
- âœ… New columns accessible
- âœ… RLS policies work correctly
- âœ… RPC returns expected JSON structure

### Phase 2: TypeScript Types & API Layer (2 hours)
**Tasks:**
1. Update `types.ts` with new interfaces
2. Create `dailyIntentionService.ts` for CRUD operations
3. Update `useDeepFocusState.ts` with new state management
4. Add API functions for:
   - fetchDailyStats()
   - createDailyIntention()
   - updateSessionGoal()
   - completeSessionWithGoal()

**Acceptance:**
- âœ… TypeScript compiles without errors
- âœ… All API functions properly typed
- âœ… State management handles new data structure

### Phase 3: New Components (4-6 hours)
**Tasks:**
1. Build `DailyIntentionModal.tsx`
   - Slider component (1-8 hours)
   - Project dropdown
   - Save/skip logic
2. Build `SessionCard.tsx`
   - Session display with goal status icons
   - Neo-brutalist styling
3. Build `TodaysActivityFeed.tsx`
   - Fetch and display today's sessions
   - Empty state handling
4. Build `DailyCapacityMeter.tsx`
   - Progress bar visualization
   - Over-target handling

**Acceptance:**
- âœ… All components render correctly
- âœ… Neo-brutalist design applied
- âœ… Responsive behavior works
- âœ… No console errors

### Phase 4: Enhance Existing Components (3-4 hours)
**Tasks:**
1. **SessionSetup.tsx**:
   - Add session goal input field (optional)
   - Preserve willpower flow
   - Pass goal to state
2. **SessionComplete.tsx**:
   - Add goal completion check (if goal exists)
   - Add session notes textarea (optional)
   - Update completion flow
3. **ActiveSession.tsx**:
   - Display session goal below project name
   - No other changes (keep timer focus)
4. **useDeepFocusState.ts**:
   - Integrate new state fields
   - Update completeSession() to handle goal_completed + notes
   - Add loadDailyStats() function
   - Add createDailyIntention() function

**Acceptance:**
- âœ… Session goal flows from setup â†’ active â†’ complete
- âœ… Goal completion properly saved to DB
- âœ… Notes saved with session
- âœ… Existing timer functionality intact

### Phase 5: Page Restructure & Integration (2-3 hours)
**Tasks:**
1. Update `page.tsx` layout:
   - Implement 60/40 split
   - Add daily capacity meter
   - Add activity feed
   - Move daily commitment slider to sidebar bottom
2. Add daily intention modal logic:
   - Check on mount if intention exists
   - Show modal on first visit if needed
   - Handle skip and save actions
3. Wire up all components
4. Test data flow end-to-end

**Acceptance:**
- âœ… Page layout matches specification
- âœ… Daily intention modal appears correctly
- âœ… Activity feed updates in real-time after session
- âœ… Capacity meter reflects progress
- âœ… All interactions work smoothly

### Phase 6: CSS & Neo-Brutalist Polish (2-3 hours)
**Tasks:**
1. Create `src/styles/features/deep-focus/timebox.css`
2. Implement new component styles following existing patterns:
   - Daily intention modal styling
   - Session card styling (borders, shadows, colors)
   - Activity feed container styling
   - Capacity meter progress bar styling
3. Ensure color consistency:
   - Dark green #224718 (calm)
   - Lime #CFE820 (energy)
   - Cream #E5EED0 (clarity)
   - Black borders, hard shadows
4. Accessibility audit (contrast ratios)

**Acceptance:**
- âœ… All new components match neo-brutalist design system
- âœ… Color palette consistent
- âœ… WCAG AA contrast compliance
- âœ… No visual regressions

### Phase 7: Testing & Bug Fixes (2-3 hours)
**Tasks:**
1. Test happy path:
   - Set daily intention â†’ start session with goal â†’ complete â†’ see in feed
2. Test edge cases:
   - Skip daily intention
   - Session without goal
   - Interrupt session with goal
   - Multiple sessions in one day
   - Exceed daily target
3. Test data persistence:
   - Refresh page during various phases
   - Navigate away and return
4. Fix any bugs discovered

**Acceptance:**
- âœ… All user flows work correctly
- âœ… No data loss on refresh
- âœ… Error states handled gracefully
- âœ… Performance acceptable (<200ms page load)

### Phase 8: Documentation & Code Review (1 hour)
**Tasks:**
1. Update `architecture.md` with new components
2. Add inline code comments for complex logic
3. Update this story document with implementation notes
4. Self code review checklist:
   - TypeScript strict mode compliance
   - No console errors
   - Neo-brutalist design consistency
   - Accessibility compliance
   - Database queries optimized

**Acceptance:**
- âœ… Documentation current and accurate
- âœ… Code review checklist complete
- âœ… Ready for user testing

## Estimated Total Time
**18-25 hours** (2-3 development days)

## Success Criteria

1. âœ… Users can set optional session goals before starting
2. âœ… Session goals visible during active session
3. âœ… Post-session: goal completion tracking (Yes/Partially/No)
4. âœ… Optional session notes captured
5. âœ… Daily intention modal appears on first visit
6. âœ… Daily capacity meter shows progress toward target
7. âœ… Today's activity feed displays all completed sessions
8. âœ… Activity feed updates immediately after session completion
9. âœ… All data persists correctly in database
10. âœ… Neo-brutalist design maintained throughout
11. âœ… Existing timer/XP functionality unaffected
12. âœ… Page performance remains fast (<200ms load time)

## Migration Rollback Plan

If critical issues arise:

```sql
-- Rollback: Remove new columns from sessions
ALTER TABLE sessions
  DROP COLUMN IF EXISTS session_goal,
  DROP COLUMN IF EXISTS goal_completed,
  DROP COLUMN IF EXISTS session_notes;

-- Rollback: Drop daily_intentions table
DROP TABLE IF EXISTS daily_intentions CASCADE;

-- Rollback: Restore original RPC if needed
-- (Keep backup of old function definition)
```

Frontend rollback: Revert to previous git commit before enhancement.

## Post-Implementation Next Steps

After Story 1.8 complete:
1. **Story 1.9**: Quick Start from TacticalMap (click project â†’ start session)
2. **Story 1.7** (revised): Analytics dashboard with session feed and project segments
3. Gather user feedback on time-boxing features
4. Iterate on daily intention UX based on usage data

---

**Notes:**
- This enhancement is backward compatible with existing sessions
- Daily intention is optional (user can skip)
- Session goals are optional (don't block flow)
- Focus on Strava-style feedback loop: plan â†’ execute â†’ reflect â†’ improve
